<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Сравнение баз данных</title>

    <!-- Bootstrap CSS (наш стиль подключается ПОСЛЕ, чтобы переопределять при необходимости) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* более уникальные классы, !important чтобы гарантированно перекрыть Bootstrap */
        td.cell-match, th.cell-match { background-color: #d4edda !important; }
        td.cell-diff, th.cell-diff { background-color: #f8d7da !important; }

        /* Делаем таблицы адаптивными и не вываливающимися за экран */
        table { table-layout: fixed; width: 100%; word-wrap: break-word; }
        td, th { max-width: 420px; overflow-wrap: anywhere; white-space: normal; vertical-align: middle; }

        .toggle-btn { cursor: pointer; user-select: none; }
        .small-muted { font-size: 0.9rem; color: #6c757d; }
    </style>
</head>
<body class="p-3">
<div class="container-fluid">
    <h1 class="mb-4">Сравнение баз данных</h1>

    <a href="/" class="button">Back to form</a>

    <!-- Список таблиц -->
    <h4>Таблицы</h4>
    <table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr><th>Таблица</th><th>{{ host1 }}</th><th>{{ host2 }}</th></tr>
        </thead>
        <tbody>
        {% for t in tables_diff %}
            <tr>
                <td>{{ t.table }}</td>
                <td class="{{ 'cell-match' if t.is_match else 'cell-diff' }}">{{ t.val1 }}</td>
                <td class="{{ 'cell-match' if t.is_match else 'cell-diff' }}">{{ t.val2 }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Структура -->
    <h4 class="mt-4">Сравнение структуры таблиц</h4>
    {% for item in structure_diff %}
        <div class="mb-2">
            <strong>{{ item.table }}</strong>
            <span class="small-muted"> (Совпадений: {{ item.match_count }}, Различий: {{ item.diff_count }})</span>
            <span class="badge bg-primary toggle-btn" onclick="toggleTable('struct_{{ loop.index }}', this)">Показать</span>
        </div>

        <table id="struct_{{ loop.index }}" class="table table-bordered table-sm" style="display:none;">
            <thead class="table-light">
                <tr><th style="width:10em">Критерий</th><th>{{ host1 }}</th><th>{{ host2 }}</th></tr>
            </thead>
            <tbody>
            {% for r in item.rows %}
                <tr>
                    <td>{{ r.crit }}</td>
                    <td class="{{ 'cell-match' if r.is_match else 'cell-diff' }}">{{ r.val1 }}</td>
                    <td class="{{ 'cell-match' if r.is_match else 'cell-diff' }}">{{ r.val2 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endfor %}

    <!-- Данные -->
    <h4 class="mt-4">Сравнение данных</h4>
    {% for item in data_diff %}
        <div class="mb-2">
            <strong>{{ item.table }}</strong>
            <span class="small-muted"> (Совпадений: {{ item.match_count }}, Различий: {{ item.diff_count }})</span>
            <span class="badge bg-primary toggle-btn" onclick="toggleTable('data_{{ loop.index }}', this)">Показать</span>
        </div>

        <table id="data_{{ loop.index }}" class="table table-bordered table-sm" style="display:none;">
            <thead class="table-light">
                <tr><th style="width:10em">Строка</th><th>{{ host1 }}</th><th>{{ host2 }}</th></tr>
            </thead>
            <tbody>
            {% for r in item.rows %}
                <tr>
                    <td>{{ r.crit }}</td>
                    <td class="{{ 'cell-match' if r.is_match else 'cell-diff' }}">{{ r.val1 }}</td>
                    <td class="{{ 'cell-match' if r.is_match else 'cell-diff' }}">{{ r.val2 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endfor %}
</div>

<script>
function toggleTable(id, btn) {
    const el = document.getElementById(id);
    if (!el) return;
    const badge = btn;
    if (el.style.display === 'none' || el.style.display === '') {
        el.style.display = 'table';
        badge.textContent = 'Скрыть';
    } else {
        el.style.display = 'none';
        badge.textContent = 'Показать';
    }
}
</script>
</body>
</html>
